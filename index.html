<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>pipe</title>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #fff;
            color: #111;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            padding: 10vh 2rem;
            display: flex;
            justify-content: center;
        }

        .container {
            width: 100%;
            max-width: 600px;
        }

        /* Layout */
        header {
            margin-bottom: 2rem;
            display: flex;
            align-items: baseline;
            justify-content: space-between;
        }

        h1 {
            font-size: 0.8rem;
            font-weight: 400;
            color: #000;
            text-transform: lowercase;
            letter-spacing: 0.05em;
        }

        .edit-hint {
            font-size: 0.7rem;
            color: #000;
            text-transform: lowercase;
            font-family: monospace;
            opacity: 0.5;
        }

        .section {
            display: none;
        }

        /* Modern Form for Password Managers */
        form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            padding-bottom: 1rem;
            margin-bottom: 2rem;
        }

        .auth-field {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .auth-label {
            font-size: 0.7rem;
            color: #666;
            text-transform: lowercase;
        }

        input[type="text"],
        input[type="password"] {
            border: none;
            outline: none;
            background: transparent;
            font-size: 1.1rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
            width: 100%;
        }

        input:focus {
            border-bottom-color: #000;
        }

        /* Readonly "username" field style */
        input.username-display {
            color: #000;
            cursor: default;
        }

        button {
            background: none;
            border: 1px solid #eee;
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            align-self: flex-start;
            text-transform: lowercase;
        }

        button:hover {
            border-color: #000;
        }

        /* Views */
        .entries-view {
            width: 100%;
            display: block;
        }

        #giantEditor {
            width: 100%;
            border: none;
            outline: none;
            background: transparent;
            word-wrap: break-word;
            display: block;
            resize: none;
            overflow: hidden;
            min-height: 70vh;
            white-space: pre-wrap;
            padding-right: 2.5rem;
            /* Reserve space for gutter */
        }

        .entries-view,
        #giantEditor {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            font-size: 1.15rem;
            line-height: 1.6;
            color: #111;
        }

        .entries-view a {
            color: #000;
            text-underline-offset: 3px;
            text-decoration-thickness: 1px;
            opacity: 0.8;
        }

        .entries-view a:hover {
            opacity: 1;
        }

        .entry-block {
            position: relative;
            margin-bottom: 1.6em;
            /* Matches line-height 1.6 exactly */
        }

        .entry-content {
            padding-right: 2.5rem;
            /* Match editor padding */
            white-space: pre-wrap;
            word-wrap: break-word;
        }

        .copy-btn {
            position: absolute;
            right: 0;
            top: 0;
            width: 2.5rem;
            height: 1.6rem;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            /* Align icon to far right of gutter */
            opacity: 0.1;
            cursor: pointer;
            color: #000;
        }

        .entry-block:hover .copy-btn,
        .copy-btn:active {
            opacity: 1;
        }
    </style>
</head>

<body>

    <div class="container">
        <!-- Global Error Handler -->
        <script>window.onerror = function (m, u, l) { alert('JS Error: ' + m + '\\nLine: ' + l); };</script>
        <!-- View Mode -->
        <div id="viewMode" class="section" style="display:block">
            <div id="entriesList" class="entries-view"></div>
        </div>

        <!-- Edit Mode -->
        <div id="editMode" class="section">
            <textarea id="giantEditor" placeholder="write..." oninput="autoExpand(this)"
                onblur="saveAndExit()"></textarea>
        </div>



    </div>

    <script>
        const gap = '\n\n';
        let allEntries = [];
        let currentPage = window.location.pathname.substring(1) || 'home';
        let currentMode = 'viewMode'; // 'viewMode' or 'editMode'
        let isTransitioning = false;
        let initialJoinedValue = '';

        // UI State
        const show = (id) => {
            currentMode = id;
            document.getElementById('viewMode').style.display = (id === 'viewMode') ? 'block' : 'none';
            document.getElementById('editMode').style.display = (id === 'editMode') ? 'block' : 'none';
        };

        // --- LOAD ---
        async function loadPage() {
            if (isTransitioning) return;
            try {
                const r = await fetch(`/entries?page=${currentPage}&t=${Date.now()}`);
                const data = await r.json();

                if (r.ok) {
                    allEntries = data;
                    renderView();
                    show('viewMode');
                } else {
                    console.error('Load failed', r.status, r.statusText);
                    allEntries = []; // Default to empty if fail
                    renderView();
                    show('viewMode');
                }
            } catch (e) {
                console.error(e);
                alert('Connection Error: ' + e.message);
            }
        }

        // --- EDITOR ---

        async function enterEditMode() {
            if (isTransitioning || currentMode === 'editMode') return;
            isTransitioning = true;

            const editor = document.getElementById('giantEditor');
            const joinedValue = allEntries.map(e => e.content).join(gap);
            initialJoinedValue = joinedValue;

            // Prepend newlines to push existing content down
            editor.value = gap + joinedValue;
            show('editMode');
            autoExpand(editor);

            // Small delay to ensure browser handled show() before focus
            setTimeout(() => {
                editor.focus({ preventScroll: true });
                editor.selectionStart = editor.selectionEnd = 0;
                window.scrollTo(0, 0);
                isTransitioning = false;
            }, 10);
        }

        async function saveAndExit() {
            if (isTransitioning || currentMode === 'viewMode') return;
            isTransitioning = true;

            const editor = document.getElementById('giantEditor');
            const raw = editor.value.trim();

            // Check if anything actually changed
            if (raw === initialJoinedValue.trim()) {
                show('viewMode');
                editor.value = '';
                isTransitioning = false;
                return;
            }

            const contents = raw === '' ? [] : raw.split(/\n\n+/).map(c => c.trim()).filter(c => c !== '');

            // Optimistic UI Update
            allEntries = contents.map((c, idx) => ({
                content: c,
                id: 'temp-' + Math.random(),
                // Space timestamps slightly to preserve order in DB
                created_at: new Date(Date.now() - (idx * 1000)).toISOString()
            }));

            renderView();
            show('viewMode');

            // Clear editor to avoid flashing old state on next open
            editor.value = '';

            // 3. Network Save
            const success = await pushContent(contents);
            if (!success) {
                alert('Failed to save. Check connection.');
            } else {
                await loadPage();
            }

            isTransitioning = false;
        }

        async function pushContent(contents) {
            try {
                const r = await fetch('/entries', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ pageName: currentPage, contents })
                });
                return r.ok;
            } catch (e) {
                console.error(e);
                return false;
            }
        }

        // --- UTILS ---

        function linkify(text) {
            const urlRegex = /((https?:\/\/)|(www\.))?([a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(\/[^\s\n]*)?/ig;
            return text.replace(urlRegex, (url) => {
                let href = url;
                if (!href.match(/^https?:\/\//i)) href = 'http://' + href;
                return `<a href="${href}" target="_blank" onclick="event.stopPropagation()">${url}</a>`;
            });
        }

        async function execCopy(btn, text) {
            try {
                await navigator.clipboard.writeText(text);
                const original = btn.innerHTML;
                btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                btn.style.opacity = '1';
                setTimeout(() => { btn.innerHTML = original; btn.style.opacity = ''; }, 1000);
            } catch (err) { }
        }

        function renderView() {
            const list = document.getElementById('entriesList');
            if (allEntries.length === 0) {
                list.innerHTML = '<div style="opacity:0.3">click to write</div>';
                return;
            }
            const copyIcon = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="13" height="13" rx="2" ry="2"></rect><rect x="9" y="9" width="13" height="13" rx="2" ry="2" fill="white"></rect></svg>';

            list.innerHTML = allEntries.map(i => {
                const safeContent = i.content
                    .replace(/\\/g, '\\\\')
                    .replace(/`/g, '\\`')
                    .replace(/\${/g, '\\${');
                const displayContent = linkify(i.content);

                return `
                    <div class="entry-block">
                        <div class="copy-btn" onclick="event.stopPropagation(); execCopy(this, \`${safeContent}\`)">${copyIcon}</div>
                        <div class="entry-content">${displayContent}</div>
                    </div>
                `;
            }).join('');
        }

        function autoExpand(t) {
            t.style.height = 'auto';
            t.style.height = t.scrollHeight + 'px';
        }

        // --- INIT ---

        window.addEventListener('click', (e) => {
            const viewMode = document.getElementById('viewMode');
            if (viewMode.style.display === 'none') return;
            if (e.target.closest('a') || e.target.closest('.copy-btn')) return;

            e.preventDefault();
            enterEditMode();
        });

        window.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                if (currentMode === 'editMode') {
                    // Trigger blur, which triggers saveAndExit
                    document.getElementById('giantEditor').blur();
                }
            }
            if (e.key === ' ' && currentMode === 'viewMode') {
                e.preventDefault(); // Prevent scroll
                enterEditMode();
            }
        });

        // Handle Back/Forward
        window.onpopstate = () => {
            currentPage = window.location.pathname.substring(1) || 'home';
            loadPage();
        };

        // --- REALTIME ---

        let supabaseClient = null;

        async function setupRealtime() {
            try {
                // 1. Get Config
                const c = await fetch('/config');
                const config = await c.json();

                // 2. Init Client
                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseKey);

                // 3. Subscribe
                supabaseClient
                    .channel('entries-updates')
                    .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'entries' }, (payload) => {
                        const entryPage = payload.new?.page_name;

                        if (entryPage && entryPage.toLowerCase() === currentPage.toLowerCase()) {
                            if (currentMode === 'editMode') {
                                // LIVE INJECT into the active editor
                                const editor = document.getElementById('giantEditor');
                                const newText = payload.new.content + gap;

                                // Save cursor position
                                const start = editor.selectionStart;
                                const end = editor.selectionEnd;

                                // Inject at top
                                editor.value = newText + editor.value;

                                // Restore cursor (shifted by new text length)
                                editor.selectionStart = start + newText.length;
                                editor.selectionEnd = end + newText.length;

                                autoExpand(editor);
                            } else {
                                loadPage();
                            }
                        }
                    })
                    .on('postgres_changes', { event: 'DELETE', schema: 'public', table: 'entries' }, (payload) => {
                        // Only reload for deletions if we are NOT editing
                        if (currentMode === 'viewMode') loadPage();
                    })
                    .subscribe();

                // console.log('Realtime connected');
            } catch (e) {
                // Silent fail
            }
        }



        // Initial Load
        loadPage();
        setupRealtime();

    </script>
</body>

</html>